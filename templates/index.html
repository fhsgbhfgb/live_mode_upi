<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice-Enabled UPI Payment</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: #fff;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      text-align: center;
      width: 100%;
      max-width: 420px;
      transition: all 0.3s ease-in-out;
    }
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .info-box {
      background: #f0f4ff;
      padding: 12px;
      border-radius: 10px;
      margin: 15px 0;
      color: #667eea;
      font-weight: 600;
      word-break: break-all;
    }
    input {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    .amount-container {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 15px 0;
    }
    .amount-container input {
      flex: 1;
      margin: 0;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin: 8px 0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .mic-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recording {
      animation: pulse 1.5s infinite;
      background: #ff4757;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    #statusMsg {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      min-height: 20px;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .nav-buttons button {
      flex: 1;
    }
    .secondary-btn {
      background: #6c757d;
    }
    .secondary-btn:hover {
      box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    }
    .success-icon {
      font-size: 64px;
      margin: 20px 0;
    }
    .payment-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: left;
    }
    .payment-details p {
      margin: 8px 0;
      color: #495057;
    }
    .payment-details strong {
      color: #212529;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Step 1: Enter UPI ID -->
  <div class="container" id="step1">
    <h2>üéØ Enter Recipient Details</h2>
    <input 
      type="text" 
      id="upiId" 
      placeholder="Recipient UPI ID (e.g., name@upi)" 
      required 
    />
    <input 
      type="text" 
      id="userName" 
      placeholder="Your Name" 
      required 
    />
    <input 
      type="email" 
      id="userEmail" 
      placeholder="Your Email" 
      required 
    />
    <input 
      type="tel" 
      id="userPhone" 
      placeholder="Your Phone (10 digits)" 
      maxlength="10"
      required 
    />
    <button onclick="nextStep()">Next ‚û°Ô∏è</button>
  </div>

  <!-- Step 2: Speak or Enter Amount -->
  <div class="container" id="step2" style="display:none;">
    <h2>üí∞ Payment Amount</h2>
    <div class="info-box">
      Paying to: <span id="upiDisplay"></span>
    </div>

    <div class="amount-container">
      <input 
        type="number" 
        id="amount" 
        placeholder="Enter amount (‚Çπ)" 
        min="1"
      />
      <button 
        id="micBtn" 
        class="mic-btn" 
        onclick="startListening()"
        title="Click to speak amount"
      >
        üé§
      </button>
    </div>

    <div id="statusMsg"></div>

    <button onclick="openPayment()">
      üí≥ Proceed to Payment
    </button>

    <div class="nav-buttons">
      <button class="secondary-btn" onclick="prevStep()">‚¨ÖÔ∏è Back</button>
    </div>
  </div>

  <!-- Step 3: Success Message -->
  <div class="container" id="step3" style="display:none;">
    <div class="success-icon">‚úÖ</div>
    <h2>Payment Successful!</h2>
    
    <div class="payment-details" id="paymentDetails"></div>

    <button onclick="goHome()">üè† Make Another Payment</button>
  </div>

  <script>
    // Configuration
    const FLASK_SERVER = "http://localhost:5000";
    
    // Global variables
    let upiId = "";
    let userName = "";
    let userEmail = "";
    let userPhone = "";
    let mediaRecorder;
    let audioChunks = [];
    let razorpayKeyId = "";

    // Fetch Razorpay key on page load
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch(`${FLASK_SERVER}/get-razorpay-key`);
        const data = await response.json();
        razorpayKeyId = data.key_id;
        console.log("Razorpay configured successfully");
      } catch (error) {
        console.error("Failed to fetch Razorpay key:", error);
        showStatus("‚ö†Ô∏è Warning: Could not connect to payment server", "error");
      }
    });

    // Helper function to show status messages
    function showStatus(message, type = "info") {
      const statusEl = document.getElementById("statusMsg");
      statusEl.innerText = message;
      statusEl.className = type === "success" ? "status-success" : 
                          type === "error" ? "status-error" : "status-info";
    }

    // Step 1 ‚Üí Step 2
    function nextStep() {
      upiId = document.getElementById("upiId").value.trim();
      userName = document.getElementById("userName").value.trim();
      userEmail = document.getElementById("userEmail").value.trim();
      userPhone = document.getElementById("userPhone").value.trim();

      // Validation
      if (!upiId) {
        alert("Please enter a valid UPI ID.");
        return;
      }
      if (!userName) {
        alert("Please enter your name.");
        return;
      }
      if (!userEmail || !userEmail.includes("@")) {
        alert("Please enter a valid email.");
        return;
      }
      if (!userPhone || userPhone.length !== 10) {
        alert("Please enter a valid 10-digit phone number.");
        return;
      }

      // Move to next step
      document.getElementById("step1").style.display = "none";
      document.getElementById("step2").style.display = "block";
      document.getElementById("upiDisplay").innerText = upiId;
    }

    // Step 2 ‚Üí Step 1 (Back)
    function prevStep() {
      document.getElementById("step2").style.display = "none";
      document.getElementById("step1").style.display = "block";
      document.getElementById("statusMsg").innerText = "";
    }

    // üè† Home Button (after success)
    function goHome() {
      document.getElementById("step3").style.display = "none";
      document.getElementById("step1").style.display = "block";
      
      // Clear all fields
      document.getElementById("upiId").value = "";
      document.getElementById("userName").value = "";
      document.getElementById("userEmail").value = "";
      document.getElementById("userPhone").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("statusMsg").innerText = "";
    }

    // üéôÔ∏è Start Recording and Send to Whisper Backend
    async function startListening() {
      const micBtn = document.getElementById("micBtn");
      
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        showStatus("üéß Listening... Speak your amount clearly", "info");
        micBtn.disabled = true;
        micBtn.classList.add("recording");
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
          showStatus("‚è≥ Processing with Whisper AI...", "info");
          micBtn.classList.remove("recording");
          
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          
          // Send to Flask backend
          const formData = new FormData();
          formData.append('audio', audioBlob, 'audio.wav');
          
          try {
            const response = await fetch(`${FLASK_SERVER}/transcribe`, {
              method: 'POST',
              body: formData
            });
            
            const result = await response.json();
            
            if (result.success && result.amount) {
              document.getElementById("amount").value = result.amount;
              showStatus(`‚úÖ Amount detected: ‚Çπ${result.amount} (You said: "${result.text}")`, "success");
            } else {
              showStatus(`‚ùå Could not detect amount. Transcribed: "${result.text}". Please enter manually.`, "error");
            }
          } catch (error) {
            showStatus("‚ùå Error connecting to server. Make sure Flask backend is running!", "error");
            console.error("Error:", error);
          }
          
          micBtn.disabled = false;
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };
        
        // Start recording
        mediaRecorder.start();
        
        // Stop after 5 seconds
        setTimeout(() => {
          if (mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }, 5000);
        
      } catch (error) {
        showStatus("‚ùå Microphone access denied! Please allow microphone access.", "error");
        micBtn.disabled = false;
        console.error("Error:", error);
      }
    }

    // üí≥ Razorpay Payment Integration with Backend Verification
    async function openPayment() {
      const amount = document.getElementById("amount").value.trim();
      
      // Validation
      if (!amount || isNaN(amount) || amount <= 0) {
        alert("Please enter or speak a valid amount.");
        return;
      }

      if (!razorpayKeyId) {
        alert("Payment gateway not configured. Please check backend setup.");
        return;
      }

      showStatus("‚è≥ Creating payment order...", "info");

      try {
        // Step 1: Create order on backend
        const orderResponse = await fetch(`${FLASK_SERVER}/create-order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            amount: parseInt(amount),
            upi_id: upiId 
          })
        });

        if (!orderResponse.ok) {
          throw new Error("Failed to create order");
        }

        const orderData = await orderResponse.json();
        
        if (!orderData.success) {
          throw new Error(orderData.error || "Order creation failed");
        }

        showStatus("‚úÖ Order created. Opening payment gateway...", "success");

        // Step 2: Open Razorpay checkout
        const options = {
          key: razorpayKeyId,
          amount: orderData.amount,
          currency: orderData.currency,
          name: "Voice Payment System",
          description: `Payment to ${upiId}`,
          image: "https://cdn-icons-png.flaticon.com/512/2875/2875428.png",
          order_id: orderData.order_id,
          handler: async function (response) {
            // Step 3: Verify payment on backend
            showStatus("‚è≥ Verifying payment...", "info");
            
            try {
              const verifyResponse = await fetch(`${FLASK_SERVER}/verify-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature
                })
              });

              const verifyData = await verifyResponse.json();

              if (verifyData.success) {
                // Show success screen
                document.getElementById("step2").style.display = "none";
                document.getElementById("step3").style.display = "block";
                
                // Display payment details
                document.getElementById("paymentDetails").innerHTML = `
                  <p><strong>Payment ID:</strong> ${verifyData.payment_id}</p>
                  <p><strong>Amount Paid:</strong> ‚Çπ${verifyData.amount}</p>
                  <p><strong>Recipient:</strong> ${upiId}</p>
                  <p><strong>Status:</strong> ${verifyData.status}</p>
                `;
              } else {
                alert("‚ùå Payment verification failed! Please contact support.");
                showStatus("‚ùå Payment verification failed", "error");
              }
            } catch (error) {
              alert("‚ùå Error verifying payment. Please contact support with your payment ID.");
              console.error("Verification error:", error);
            }
          },
          prefill: {
            name: userName,
            email: userEmail,
            contact: userPhone
          },
          notes: {
            recipient_upi: upiId
          },
          theme: {
            color: "#667eea"
          },
          modal: {
            ondismiss: function() {
              showStatus("Payment cancelled by user", "info");
            }
          }
        };

        const rzp = new Razorpay(options);
        
        rzp.on('payment.failed', function (response) {
          alert(`Payment Failed: ${response.error.description}`);
          showStatus(`‚ùå Payment failed: ${response.error.reason}`, "error");
        });

        rzp.open();

      } catch (error) {
        alert("‚ùå Error creating payment order. Please try again.");
        showStatus("‚ùå Error: " + error.message, "error");
        console.error("Payment error:", error);
      }
    }
  </script>
</body>
</html>
